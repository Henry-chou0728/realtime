# 【技術報告】OpenAI 即時語音中繼伺服器系統

## 一、 系統核心目的
本程式的主要功能是建立一個 **安全中繼站 (Security Proxy)**，解決 Web 端直接調用 AI 接口時最嚴重的金鑰洩露問題。

* **傳統風險**：
    若將 `OPENAI_API_KEY` 直接寫在前端 JavaScript 代碼中，任何使用者都能透過瀏覽器「檢視原始碼」功能輕易竊取金鑰，導致帳戶點數被盜用或惡意濫用。
* **本系統解決方案**：
    由後端伺服器 (**FastAPI**) 安全地保管永久金鑰，僅向前端發放 **「限時 1 分鐘有效」** 的臨時通行證（Ephemeral Token）。即便該憑證外洩，也會在極短時間內失效，確保系統整體的安全性。

---

## 二、 運作流程說明
此架構確保了金鑰不外流，並利用 **WebRTC** 技術實現極低延遲的語音對話。



1.  **使用者存取**：使用者透過瀏覽器開啟首頁路徑 (`/`)。
2.  **前端請求**：前端網頁載入後，自動向後端發送請求以獲取短期通行證 (`/session`)。
3.  **後端代理**：
    * **FastAPI** 接收請求並確認權限。
    * 使用內部環境變數中的 `OPENAI_API_KEY` 向 OpenAI 伺服器發送申請。
4.  **憑證核發**：OpenAI 驗證後，回傳一個短效的 **Ephemeral Session Token**。
5.  **建立通訊**：前端接收 Token，利用 WebRTC 技術與 OpenAI 建立加密的語音串流通道，開始對話。

---

## 三、 程式核心功能拆解

### 1. 介面提供服務 (`/`)
* **執行動作**：從伺服器本地磁碟讀取 `test.html` 檔案。
* **回傳格式**：`HTMLResponse`，直接渲染前端介面。
* **主要用途**：提供使用者操作按鈕（啟動/停止）、麥克風存取授權以及 WebRTC 連線邏輯。

### 2. 短期憑證核發服務 (`/session`)
這是系統的安全核心，在申請憑證時已預設三項關鍵參數，優化使用者體驗：
* **高效模型**：選用 `gpt-4o-mini-realtime-preview`，大幅縮短語音處理的延遲時間。
* **親切音色**：指定 `marin` 女聲，使 AI 回饋更具人性化與親和力。
* **行為校準 (Instructions)**：強制模型使用 **「繁體中文（台灣用語）」**，確保對話口吻自然且符合在地語言習慣。

---

## 四、 技術規格快速對照表

| 項目 | 詳細內容 |
| :--- | :--- |
| **後端開發框架** | FastAPI (Python 3.10+) |
| **HTTP 請求庫** | `httpx` (支持非同步 Async 處理) |
| **通訊協定** | HTTP (Token 請求) / WebRTC (即時語音傳輸) |
| **安全機制** | API Key 不落地、限時 Ephemeral Token |
| **環境變數管理** | `python-dotenv` |
| **支援語系** | 繁體中文（台灣習慣用語） |

---

## 五、 如何部署與測試運行

### 1. 環境配置
在專案根目錄建立 `.env` 檔案，並填入您的 API 金鑰：
```env
OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxxxxxx
